openapi: 3.0.0
info:
  title: Task Management API
  version: 1.0.0
  description: >
    Task Management backend with JWT Auth, RBAC, manager team handling, search,
    filtering, redis caching, and task assignment.

servers:
  - url: http://localhost:5000/api
    description: Local server

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        _id:
          type: string
        username:
          type: string
        email:
          type: string
        password:
          type: string
        role:
          type: string
          enum: [USER, MANAGER, ADMIN]
        team:
          type: array
          items:
            type: string
        lastLogoutAt:
          type: string
          format: date-time

    Task:
      type: object
      properties:
        _id:
          type: string
        title:
          type: string
        description:
          type: string
        priority:
          type: string
          enum: [LOW, MEDIUM, HIGH]
        status:
          type: string
          enum: [PENDING, IN_PROGRESS, COMPLETED]
        dueDate:
          type: string
          format: date-time
        assignedTo:
          $ref: "#/components/schemas/User"
        createdBy:
          $ref: "#/components/schemas/User"

security:
  - BearerAuth: []

paths:
  ############################################
  # AUTH ROUTES
  ############################################

  /auth/register:
    post:
      summary: Register a new user
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, email, password]
              properties:
                username:
                  type: string
                  example: aman123
                email:
                  type: string
                  example: user@example.com
                password:
                  type: string
                  example: strongPassword123
      responses:
        201:
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User registered
                  userId:
                    type: string
                    example: "65fa83f1ac34b99f12d4ab8a"

        400:
          description: Validation error (email or password)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Email already exists

        500:
          description: Server error

  /auth/login:
    post:
      summary: Login user and return a JWT token
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  example: user@example.com
                password:
                  type: string
                  example: strongPassword123
      responses:
        200:
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

        401:
          description: Invalid credentials
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Invalid credentials

        500:
          description: Server error

  /auth/logout:
    post:
      summary: Logout user (invalidate token + clear cache)
      tags: [Authentication]
      security:
        - BearerAuth: []
      responses:
        200:
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully. Token is now invalid.

        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Unauthorized - Invalid or expired token

        500:
          description: Server error during logout
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Server error during logout

  ############################################
  # USER ROUTE
  ############################################

  /auth/profile:
    get:
      summary: Get logged-in user profile
      tags: [Users]
      security:
        - BearerAuth: []
      responses:
        200:
          description: Profile fetched successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  username:
                    type: string
                    example: aman123
                  email:
                    type: string
                    example: user@example.com
                  role:
                    type: string
                    enum: [USER, MANAGER, ADMIN]
                  createdAt:
                    type: string
                    format: date-time
                  updatedAt:
                    type: string
                    format: date-time

        401:
          description: Unauthorized (missing or invalid token)

        500:
          description: Server error fetching profile

  ############################################
  # TASK ROUTES
  ############################################

  /tasks:
    post:
      tags:
        - Tasks
      summary: Create a new task
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - assignedTo
              properties:
                title:
                  type: string
                  example: "Finish documentation"
                description:
                  type: string
                  example: "Write Swagger docs for API"
                dueDate:
                  type: string
                  format: date
                  example: "2025-01-30"
                priority:
                  type: string
                  enum: [LOW, MEDIUM, HIGH]
                  example: HIGH
                assignedTo:
                  type: string
                  description: User ID of assigned user
                  example: "67af1e23b91bcfd45ae59000"
      responses:
        201:
          description: Task created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Task"
        403:
          description: Manager tried assigning task outside team
        500:
          description: Server error

    get:
      tags:
        - Tasks
      summary: Get tasks with filters
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [PENDING, IN_PROGRESS, COMPLETED]
        - in: query
          name: priority
          schema:
            type: string
            enum: [LOW, MEDIUM, HIGH]
        - in: query
          name: search
          schema:
            type: string
            example: "meeting"
        - in: query
          name: from
          schema:
            type: string
            format: date
        - in: query
          name: to
          schema:
            type: string
            format: date
      responses:
        200:
          description: Task list fetched
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Task"
        500:
          description: Server error

  /tasks/{id}:
    put:
      tags:
        - Tasks
      summary: Update a task
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string }
                description: { type: string }
                priority:
                  type: string
                  enum: [LOW, MEDIUM, HIGH]
                status:
                  type: string
                  enum: [PENDING, IN_PROGRESS, COMPLETED]
                dueDate:
                  type: string
                  format: date
      responses:
        200:
          description: Task updated successfully
        403:
          description: Manager not allowed to update
        404:
          description: Task not found
        500:
          description: Server error

    delete:
      tags:
        - Tasks
      summary: Delete a task
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        200:
          description: Task deleted
        403:
          description: Manager not allowed to delete
        404:
          description: Task not found
        500:
          description: Server error

  /team/add-member:
    post:
      tags:
        - Team Management
      summary: Add a user to a manager's team
      description: Allows Admin or the Manager himself to add a user to the manager's team.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - managerId
                - userId
              properties:
                managerId:
                  type: string
                  description: ID of the manager
                  example: "675f5c12ab34ff11c98b22d9"
                userId:
                  type: string
                  description: ID of the user to add in team
                  example: "675f5d09de18ab10d09a1133"
      responses:
        "200":
          description: Team member added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Team member added
                  manager:
                    $ref: "#/components/schemas/User"
        "400":
          description: Bad Request — Duplicate user or invalid manager
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User already in team
        "403":
          description: Unauthorized — Only Admin or the manager can add team members
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Not authorized
        "404":
          description: Manager or User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Manager or User not found
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Something went wrong on the server        
